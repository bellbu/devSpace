wp_posts.id = wp_postmeta.post_id, wp_rsv_m.post_id, wp_rsv_d.post_id
wp_postmeta.meta_key = wp_rsv_m.meta_key,wp_rsv_d.meta_key

* 예약오픈 시 이슈해결 정리
1. 테이블 정리
  1) 프로그램 관리 테이블 : wp_posts (PK: ID)
  2) 구 예약데이터 테이블 : wp_postmeta(PK: meta_id)
  3) 신규 예약데이터 테이블: wp_rsv_m(PK: rsv_no) - 개인정보 암호화 되어있음
  4) 신규 예약데이터 디테일 테이블: wp_rsv_d(PK: rsv_no, rsv_seq) - 개인정보 암호화 되어있음

2. 발생예상 문제
  1) 기존 예약테이블의 예약키는 wp_postmeta 의 meta_key
  meta_key는 시간을 만들어지기 때문에 중복되는 값이 생길 수 있어서 문제가 발생

  질문0) 예약하는 경우 구예약테이블, 신규예약테이블 마스터, 신규예약테이블 디테일 3개 테이블 인서트 되는지??
  질문1) 구 예약데이터의 meta_key 영문인 경우 무슨의미?? 
  질문2) 프로그램 관리 테이블의 post_content의 예약인원 reserved_count 확인 방법??


3. 프로그램 오픈 시 체크
  1) 기존 예약키 중복으로 A의 예약을 취소 시 B의 예약도 취소 될 수 있음.
    - 신규 예약데이터 테이블의 예약번호(rsv_no)는 다르게 생성되더라도 구 예약키가 동일하여 구 예약테이블의 예약데이터를 취소 시키고  프로그램 인원도 따로 조정될 수 있음.
    - 처리방법 : meta_key의 값을 1씩 증가해서 조회하여 데이터가 없을 경우 중복되는 예약 중 하나를 해당 key로 변경해준다
              구 예약테이블, 신규예약 마스터, 신규예약 디테일 3개 테이블 수정 필요

  2) 신규 예약테이블 메인(wp_rsv_m) 에 데이터가 생성되지 않을 수 있음.
    - 두건의 예약건이 하나의 예약번호에 seq가 확장되어 생성될 수 있음.
      ex) 원래대로면 (MK000001, 1),  (MK000002, 1) 로 생성되어야 하나, (MK000001, 1),  (MK000001, 2) 로 생성되는 케이스 존재
    - 처리방법 : 1 의 처리방법으로 meta_key 중복 해소 후 신규예약번호(MAX(RSV_NO) 생성하여  분기

  3) 1번의 케이스로 프로그램인원이 맞지 않을 수 있음.
    - 실제 예약데이터의 인원수와 프로그램의 예약인원수가 맞지 않는 케이스 존재
    - 처리방법 : wp_posts 의 post_date 로 프로그램 일정 확인 후, id 값이 프로그램 키이며,  해당 row의 post_content 값중 reserved_count 가 예약인원 
                wp_posts 의 예약인원, wp_postmeta 의 예약인원, wp_rsv_m 의 예약인원이 일치해야함.

※ wp_posts.id 인원 = wp_postmeta.post_id 인원 합산 = wp_rsv_m.post_id 인원 합산
※ 각 테이블의 meta_key 1:1:1 관계여야 함 

아래 쿼리 중 키(meta_key) 중복조회 쿼리 실행하여 조회되는게 없을 경우 김치간에서 메일오는 건에 대하여 확인해주면 됨.

--------------------------------------------------------------------------------------------------

* 쿼리 조회
1) 키(meta_key) 중복조회 쿼리
  select * 
  from (
        select post_id,
               meta_key,
               count(*) cnt 
        from wp_postmeta 
        where post_id in(select id from wp_posts wp where post_date > now())
        group by post_id, meta_key
      ) a
  where a.cnt > 1

2) 프로그램(wp_posts) 조회(조건은 변경해도됨)
  select * 
  from wp_posts
  where post_date like '2023-09%'

3) 구 예약데이터 테이블(wp_postmeta) 조회(조건은 변경해서 조회)
  select * 
  from wp_postmeta wp 
  where 1=1
  and post_id = 10484
  and meta_key = '1692334885'

4) 신규 예약데이터 테이블 마스터(wp_rsv_m) 조회(조건은 변경해서 조회)
  SELECT rsv_no,
        post_id,
        meta_key,
        cast(AES_DECRYPT(UNHEX(name), 'name') as char(127) character set utf8)   name,
        cast(AES_DECRYPT(UNHEX(hp_no), 'hp_no') as char(127) character set utf8) hp_no,
        cast(AES_DECRYPT(UNHEX(mail), 'mail') as char(127) character set utf8) mail,
        cast(AES_DECRYPT(UNHEX(home_addr1), 'addr1') as char(127) character set utf8) addr1,
        cast(AES_DECRYPT(UNHEX(home_addr2), 'addr2') as char(127) character set utf8) addr2,
        mem_cnt 
  FROM wp_rsv_m a
  where 1=1
  and rsv_no = 'MK?'
  #and post_id = ?
  #and meta_key = '?'



5) 신규 예약데이터 테이블 디테일(wp_rsv_d) 조회(조건은 변경해서 조회)
  SELECT rsv_no,
         post_id,
         meta_key,
         rsv_seq,
         cast(AES_DECRYPT(UNHEX(name), 'name') as char(127) character set utf8)   name,
         cast(AES_DECRYPT(UNHEX(hp_no), 'hp_no') as char(127) character set utf8) hp_no,
         cast(AES_DECRYPT(UNHEX(mail), 'mail') as char(127) character set utf8) mail,
         ins_date,
         mem_cnt  
  from wp_rsv_d
  where 1=1
  and rsv_no = 'MK233548'
  #and post_id = 10488
  #and meta_key = '1692335096'
  order by rsv_no,rsv_seq


6) 구 예약테이블(wp_postmeta) 인원체크 ( 프로그램 별 인원체크 )
  select * 
  from wp_postmeta
  where post_id = 10489
  and meta_value like '%num";s:1%'

7) 신규 예약데이터 테이블 마스터(wp_rsv_m) 인원체크
  select post_id,
        sum(mem_cnt) 
  from wp_rsv_m
  where post_id between 10476 and 10489
  group by post_id


8) 개인정보 수정시 암호화 업데이트
  UPDATE wp_rsv_m
  SET
      name = hex(aes_encrypt(%s,'name')) ,
      hp_no = hex(aes_encrypt(%s,'hp_no')) ,
      mail = hex(aes_encrypt(%s,'mail')) ,
      mem_cnt = %d,
      upd_date = NOW()
  WHERE rsv_no = %s